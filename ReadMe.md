# â€œè¥¿å°çº¢â€è¥¿å—å¤§å­¦çº¢åå­—ä¼šå¿—æ„¿æœåŠ¡ç®¡ç†ç³»ç»Ÿâ€”åç«¯
â­åŸºäºSpringBootä¸Vueçš„å¿—æ„¿æœåŠ¡ç®¡ç†ç³»ç»Ÿç³»ç»Ÿï¼Œç”¨äºç®€åŒ–å¿—æ„¿æœåŠ¡æµç¨‹ï¼Œæé«˜å¿—æ„¿æœåŠ¡æ•ˆç‡ã€‚

**æ¥å£æ–‡æ¡£**ï¼šhttps://apifox.com/apidoc/shared-51abf509-a67a-4bff-9b64-21ae1adc42bd

**åç«¯æŠ€æœ¯æ ˆ**ï¼š

- ğŸ˜„SpringBoot + MyBatis-Plus
- ğŸ”’SpringSecurity + JWT+Redisï¼šé‰´æƒ
- â¤Redisï¼šç”¨æˆ·ä¿¡æ¯ç¼“å­˜ã€å¿—æ„¿æ´»åŠ¨æ‹›å‹Ÿæ•°æ®ç¼“å­˜
- âœ‰ï¸JavaMail+FreeMarkerï¼šé‚®ä»¶æ¨¡æ¿çš„å¡«å……å’Œå‘é€åŠŸèƒ½
- ğŸ§šâ€â™‚ï¸okHttp + Nettyå»ºç«‹å‰ç«¯ã€åç«¯ã€å¤§æ¨¡å‹çš„websocketè¿æ¥ï¼Œè°ƒç”¨æ˜Ÿç«å¤§æ¨¡å‹APIå®ç°æµå¼é—®ç­”ã€‚
- ğŸ›’Redissäº‹åŠ¡ã€Luaè„šæœ¬å®ç°é™é‡å¿—æ„¿è€…æ‹›å‹Ÿäººæ•°ç§’æ€
- â›·ï¸RabbitMQæ¶ˆæ¯é‡è¯•æœºåˆ¶ä¸ä¹è§‚é”ä¿è¯æ´»åŠ¨é‚®ä»¶æ­£ç¡®å‘é€ 
- :file_folder:ä¸ƒç‰›äº‘OSSï¼šå›¾ç‰‡å­˜å‚¨ 

**å‰ç«¯æŠ€æœ¯æ ˆ**ï¼š

â€‹	åå°ï¼šVue2+ vue-template-admin + Element-UI

â€‹	å¾®ä¿¡å°ç¨‹åºï¼šåŸç”Ÿå¼€å‘

**éƒ¨ç½²**ï¼šDocker + Nginx

**TODO**ï¼š

- [ ] æ›´å®Œå–„çš„æƒé™æ§åˆ¶
- [ ] æ‹†ä¸ºå¾®æœåŠ¡

æœ¬ç³»ç»Ÿè¿˜æœ‰å¾ˆå¤šä¸å®Œå–„çš„åœ°æ–¹ï¼Œå¦‚æœæ‚¨æœ‰å®è´µçš„å»ºè®®ã€ä¸æ»¡ or ç–‘é—®ï¼Œæ¬¢è¿æissueï¼ä½œè€…å°†å°½å¿«å›å¤ã€‚

å¦‚æœä½ å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ï¼Œæƒ³è¦ä¸€èµ·è®©å®ƒå˜å¾—æ›´å¥½ï¼Œæ¬¢è¿è”ç³»æˆ‘ä¸€èµ·contributeï¼mailï¼šqwretrh@qq.com

## æ•ˆæœé¢„è§ˆ

![image](https://gitee.com/world_heping/RedCross/raw/front-admin/src/assets/readme/1721279956558.png)

![image](https://gitee.com/world_heping/RedCross/raw/front-admin/src/assets/readme/1721279704101.png)

![image](https://gitee.com/world_heping/RedCross/raw/front-admin/src/assets/readme/1721279851836.png)

![image](https://gitee.com/world_heping/RedCross/raw/front-admin/src/assets/readme/1721279902568.png)

## åç«¯è¿è¡Œ

**åç«¯é¡¹ç›®åœ¨masteråˆ†æ”¯ä¸‹ï¼Œå‰ç«¯åå°é¡¹ç›®åœ¨frontend-adminåˆ†æ”¯ä¸‹ï¼Œå‰ç«¯å¾®ä¿¡å°ç¨‹åºåœ¨front-weixinåˆ†æ”¯ä¸‹ã€‚**

å°†RedCrossé¡¹ç›®cloneè‡³æœ¬åœ°ç›®å½•ã€‚åˆ·æ–°mavenä¾èµ–

è‹¥èƒ½å¤Ÿå¯åŠ¨ï¼Œåœ¨framework/src/main/resourcesä¸‹åˆ›å»º.envæ–‡ä»¶ç”¨ä»¥æ›´æ”¹`application.yml`ä¸­MySQLã€Redisã€RabbitMQç›¸å…³è®¾ç½®ï¼Œä»¥åŠå¤§æ¨¡å‹ä¸ä¸ƒç‰›äº‘keyï¼Œå†æ¬¡Runï¼Œé¡¹ç›®åº”èƒ½æ­£ç¡®è¿è¡Œã€‚

**envæ¨¡æ¿å¦‚ä¸‹ï¼š**

```xml
# å¼€å‘ç¯å¢ƒ
DEV_BASEURL=
# ç”Ÿäº§ç¯å¢ƒ
PROD_BASEURL=
# æµ‹è¯•ç¯å¢ƒ
TEST_BASEURL=
# MySQLé…ç½®
MYSQL_USER_NAME=
MYSQL_PASSWORD=
# Redisé…ç½®
REDIS_PASSWORD=
# RabbitMQé…ç½®
RABBITMQ_USER_NAME=
RABBITMQ_PASSWORD=
# é‚®ä»¶é…ç½®
MAIL_HOST=
MAIL_USER_NAME=
MAIL_PASSWORD=
# ä¸ƒç‰›äº‘OSSé…ç½®
OSS_ACCESS_KEY=
OSS_SECRET_KEY=
OSS_BUCKET=
# æ˜Ÿç«å¤§æ¨¡å‹é…ç½®
LLM_APPID=
LLM_API_SECRET=
LLM_API_KEY=
LLM_HOST_URL=
# å¾®ä¿¡é…ç½®
WEIXIN_JSCODE2_SESSION_URL=
WEIXIN_APP_ID=
WEIXIN_SECRET=
```

## éƒ¨ç½²

### æ³¨ï¼š

éƒ¨ç½²é‡‡ç”¨Linuxäº‘æœåŠ¡å™¨+dockerå®¹å™¨åŒ–çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œä¸€åˆ‡æœ‰å…³æ–‡ä»¶å­˜å‚¨åœ¨/mydataç›®å½•ä¸‹

```shell
mkdir /mydata
```

2024.7.7æ›´æ–°

[å¯ä»¥é‡‡ç”¨docker-Composeçš„æ–¹å¼éƒ¨ç½²](#dockercompose) 

### ä¸€ã€dockerå®‰è£…

#### 1.å®‰è£…ç›¸å…³ä¾èµ–

``` shell
yum install -y yum-utils  device-mapper-persistent-data   lvm2
```

#### 2.è®¾ç½® docker repo çš„ yum ä½ç½® 

```shell
yum-config-manager  --add-repo  https://download.docker.com/linux/centos/docker-ce.repo 
```

#### 3.å®‰è£…docker

```shel
yum install docker-ce docker-ce-cli containerd.io
```

#### 4.å¯åŠ¨docker

```shell
systemctl start docker
```

#### 5.å¼€æœºè‡ªå¯docker

```shell
systemctl enable docker
```

#### 6.Dockerå¼€å¯è¿œç¨‹API(è®°å¾—å¼€æ”¾2375ç«¯å£)

ä¿®æ”¹docker.serviceæ–‡ä»¶

```shell 
vim /usr/lib/systemd/system/docker.service
```

éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼š

```shell 
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
```

ä¿®æ”¹åçš„éƒ¨åˆ†ï¼š

```shell 
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock
```

#### é…ç½®ç”Ÿæ•ˆ

```shell
systemctl daemon-reload
```

#### é‡æ–°å¯åŠ¨DockeræœåŠ¡

```shell
systemctl restart docker
```

#### 7.é…ç½®é•œåƒä»“åº“

```shell
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
    "registry-mirrors": [
        "https://docker.m.daocloud.io",
        "https://huecker.io",
        "https://dockerhub.timeweb.cloud",
        "https://noohub.ru"
    ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker 
```

#### 8.å¯è§†åŒ–å·¥å…·Portaineréƒ¨ç½²(å¯ä»¥ä¸ç®¡)

```shell
 docker volume create portainer_data
 
 docker run -d -p 8000:8000 -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce
 
 
 #ç”¨äºéƒ¨ç½²è¿è¡Œæ‰€ä¾èµ–çš„æœåŠ¡
version: '3.9'
services:
  # åŸºç¡€ç¯å¢ƒç»„ä»¶
  # 1.Portainer
  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M
    ports:
      - "9999:9000"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock #æ•°æ®æ–‡ä»¶æŒ‚è½½
      - portainer_data:/data portainer/portainer-ce #é…ç½®æ–‡ä»¶æŒ‚è½½
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone/timezone:/etc/timezone:ro
 
# å­˜å‚¨å·
volumes:
  portainer_data:
```



### äºŒã€æ•°æ®åº“é…ç½®

#### 1. æ•°æ®åº“é•œåƒåˆ›å»ºï¼ˆé‡‡ç”¨mysqlæ•°æ®åº“ï¼‰

```shell
docker pull mysql:8.0 //æ‹‰å–mysql8.0é•œåƒ
```

#### 2. æ•°æ®åº“å®¹å™¨åˆ›å»º

##### 2.1åœ¨æœ¬åœ°åˆ›å»ºæ–‡ä»¶å¤¹/mydata/mysqlï¼ˆ -v æ˜¯å°†æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œå½¢æˆæ˜ å°„ ï¼‰

```shell
mkdir /mydata/mysql

docker run -d --name mysql --restart=always -p 3306:3306 -v /mydata/mysql:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=theRedCross1993 mysql:8.0
```

#### 3.æ•°æ®åº“sqlå¯¼å…¥

##### 3.1 è¿›å…¥å®¹å™¨

```shell
docker exec -it mysql8 /bin/bash
```

##### 3.2 æ•°æ®åº“å®¹å™¨è¿›å…¥æ•°æ®åº“åè¿è¡Œ   

```shell
mysql -uroot -ptheRedCross1993

alter user 'root'@'%' identified with mysql_native_password by 'theRedCross1993';
flush privileges;

exit
exit
docker restart mysql8
```

### ä¸‰ã€RabbitMQ

#### 1.åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨äºæŒ‚è½½rabbitmqçš„æ’ä»¶

~~~shell
mkdir /mydata/mq-plugins
~~~

#### 2.æŸ¥æ‰¾æˆ‘ä»¬éœ€è¦çš„é•œåƒ

~~~shell
docker search rabbitmq
~~~

#### 3.æ‹‰å–é•œåƒ(æˆ‘ä»¬é€‰æ‹©äº†STARSæ•°æœ€å¤šçš„å®˜æ–¹é•œåƒï¼Œæ­¤å¤„éœ€è¦æ³¨æ„ï¼Œé»˜è®¤[rabbitmq](https://so.csdn.net/so/search?q=rabbitmq&spm=1001.2101.3001.7020)é•œåƒæ˜¯ä¸å¸¦webç«¯ç®¡ç†æ’ä»¶çš„ï¼Œæ‰€ä»¥æŒ‡å®šäº†é•œåƒtagä¸º3.8-managementï¼Œè¡¨ç¤ºä¸‹è½½åŒ…å«webç®¡ç†æ’ä»¶ç‰ˆæœ¬é•œåƒ)

~~~shell
docker pull rabbitmq:3.8-management
~~~

#### 4.åˆ›å»ºå·¥å…·å®¹å™¨

```shell
docker run \
 --name mq \
 --hostname mq \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 --privileged=true \
 rabbitmq:3.8-management
```

åˆ›å»ºå·¥å…·å®¹å™¨ç›®çš„æ˜¯å°†å®¹å™¨å†…éƒ¨æ’ä»¶ç›®å½•æ‹·è´å‡ºæ¥ï¼Œåœ¨æ–°å»ºå®¹å™¨æ—¶å°†å®¿ä¸»æœºçš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ã€‚

#### 5.æ‹·è´å‡ºæ¥æ’ä»¶ç›®å½•

~~~shell
docker cp mq:/plugins/. /mydata/mq-plugins
~~~

#### 6.å†å°†å·¥å…·å®¹å™¨åˆ é™¤ååˆ›å»ºå®¹å™¨

 ~~~shell
# åˆ é™¤å·¥å…·å®¹å™¨
docker kill mq
docker rm mq

# æ–°å»ºå®¹å™¨
docker run \
 -e RABBITMQ_DEFAULT_USER=theRedCross \
 -e RABBITMQ_DEFAULT_PASS=theRedCross1993 \
 -v /mydata/mq-plugins:/plugins \
 --name mq \
 --hostname mq \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 --privileged=true \
 --restart=always \
 rabbitmq:3.8-management
 ~~~

### å››ã€Redis

#### 1.Redisé…ç½®

##### 1.1 RedisæœåŠ¡å™¨é…ç½®æ–‡ä»¶

~~~xml
# ç»‘å®šIPåœ°å€
#è§£é™¤æœ¬åœ°é™åˆ¶ æ³¨é‡Šbind 127.0.0.1  
#bind 127.0.0.1  
 
# æœåŠ¡å™¨ç«¯å£å·  
port 6379 
 
#é…ç½®å¯†ç ï¼Œä¸è¦å¯ä»¥åˆ æ‰
requirepass theRedCross1993
 
#è¿™ä¸ªé…ç½®ä¸è¦ä¼šå’Œdocker -d å‘½ä»¤ å†²çª
# æœåŠ¡å™¨è¿è¡Œæ¨¡å¼ï¼ŒRedisä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ,é»˜è®¤ä¸ºnoï¼Œæ”¹ä¸ºyesæ„ä¸ºä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼å¯åŠ¨ï¼Œå¯åå°è¿è¡Œï¼Œé™¤ékillè¿›ç¨‹ï¼Œæ”¹ä¸ºyesä¼šä½¿é…ç½®æ–‡ä»¶æ–¹å¼å¯åŠ¨rediså¤±è´¥ï¼Œå¦‚æœåé¢rediså¯åŠ¨å¤±è´¥ï¼Œå°±å°†è¿™ä¸ªæ³¨é‡Šæ‰
daemonize no
 
#å½“Redisä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼ŒRedisé»˜è®¤ä¼šæŠŠpidå†™å…¥/var/run/redis.pidæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡pidfileæŒ‡å®š(è‡ªå®šä¹‰)
#pidfile /data/dockerData/redis/run/redis6379.pid  
 
#é»˜è®¤ä¸ºnoï¼ŒredisæŒä¹…åŒ–ï¼Œå¯ä»¥æ”¹ä¸ºyes
appendonly yes
 
#å½“å®¢æˆ·ç«¯é—²ç½®å¤šé•¿æ—¶é—´åå…³é—­è¿æ¥ï¼Œå¦‚æœæŒ‡å®šä¸º0ï¼Œè¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½
timeout 60
# æœåŠ¡å™¨ç³»ç»Ÿé»˜è®¤é…ç½®å‚æ•°å½±å“ Redis çš„åº”ç”¨
maxclients 10000
tcp-keepalive 300
 
#æŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥å¤šä¸ªæ¡ä»¶é…åˆï¼ˆåˆ†åˆ«è¡¨ç¤º900ç§’ï¼ˆ15åˆ†é’Ÿï¼‰å†…æœ‰1ä¸ªæ›´æ”¹ï¼Œ300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰å†…æœ‰10ä¸ªæ›´æ”¹ä»¥åŠ60ç§’å†…æœ‰10000ä¸ªæ›´æ”¹ï¼‰
save 900 1
save 300 10
save 60 10000
 
# æŒ‰éœ€æ±‚è°ƒæ•´ Redis çº¿ç¨‹æ•°
tcp-backlog 511
 
# è®¾ç½®æ•°æ®åº“æ•°é‡ï¼Œè¿™é‡Œè®¾ç½®ä¸º16ä¸ªæ•°æ®åº“  
databases 16
 
# å¯ç”¨ AOF, AOFå¸¸è§„é…ç½®
appendonly yes
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
 
# æ…¢æŸ¥è¯¢é˜ˆå€¼
slowlog-log-slower-than 10000
slowlog-max-len 128
 
# æ˜¯å¦è®°å½•ç³»ç»Ÿæ—¥å¿—ï¼Œé»˜è®¤ä¸ºyes  
syslog-enabled yes  
 
#æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«ï¼ŒRedisæ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warningï¼Œé»˜è®¤ä¸ºverbose
loglevel notice
  
# æ—¥å¿—è¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºstdoutï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ–‡ä»¶è·¯å¾„  
logfile stdout
 
# æ—¥å¿—æ–‡ä»¶
#logfile /var/log/redis/redis-server.log

# ç³»ç»Ÿå†…å­˜è°ƒä¼˜å‚æ•°   
# æŒ‰éœ€æ±‚è®¾ç½®
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-entries 512
list-max-ziplist-value 64
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
~~~

###### 1.1.1é…ç½®è§£é‡Š

~~~xml
daemonize no
# é»˜è®¤æƒ…å†µä¸‹ï¼Œredisä¸æ˜¯åœ¨åå°è¿è¡Œçš„ã€‚å¦‚æœéœ€è¦åœ¨åå°è¿è¡Œï¼ŒæŠŠè¯¥é¡¹çš„å€¼æ›´æ”¹ä¸ºyesã€‚
 
pidfile /var/run/redis.pid
# å½“redisåœ¨åå°è¿è¡Œçš„æ—¶å€™ï¼Œredisé»˜è®¤ä¼šæŠŠpidæ–‡ä»¶æ”¾åœ¨/var/run/redis.pidï¼Œä½ å¯ä»¥é…ç½®åˆ°å…¶ä»–ä½ç½®ã€‚å½“è¿è¡Œå¤šä¸ªredisæœåŠ¡æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸åŒçš„pidæ–‡ä»¶å’Œç«¯å£ã€‚
 
port 6379
# æŒ‡å®šredisè¿è¡Œçš„ç«¯å£ï¼Œé»˜è®¤æ˜¯6379ã€‚
  
bind 127.0.0.1
# æŒ‡å®šredisåªæ¥æ”¶æ¥è‡ªäºè¯¥IPåœ°å€çš„è¯·æ±‚çœ‹ï¼Œå¦‚æœä¸è¿›è¡Œè®¾ç½®ï¼Œé‚£ä¹ˆå°†å¤„ç†æ‰€æœ‰è¯·æ±‚ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¥½è®¾ç½®è¯¥é¡¹ã€‚
 
loglevel debug
# æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«ï¼Œå…¶ä¸­redisæ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warningï¼Œé»˜è®¤ä¸ºverboseã€‚
# 1 . debugè¡¨ç¤ºè®°å½•å¾ˆå¤šä¿¡æ¯,ç”¨äºå¼€å‘å’Œæµ‹è¯•
# 2ï¼verboseè¡¨ç¤ºè®°å½•æœ‰ç”¨çš„ä¿¡æ¯, ä½†ä¸åƒdebugä¼šè®°å½•é‚£ä¹ˆå¤š
# 3ï¼noticeè¡¨ç¤ºæ™®é€šçš„verboseï¼Œå¸¸ç”¨äºç”Ÿäº§ç¯å¢ƒ
# 4ï¼warning è¡¨ç¤ºåªæœ‰éå¸¸é‡è¦æˆ–è€…ä¸¥é‡çš„ä¿¡æ¯ä¼šè®°å½•åˆ°æ—¥å¿—
 
logfile /var/log/redis/redis.log
# é…ç½®logæ–‡ä»¶åœ°å€,é»˜è®¤å€¼ä¸ºstdoutã€‚è‹¥åå°æ¨¡å¼ä¼šè¾“å‡ºåˆ°/dev/nullã€‚
 
databases 16
# å¯ç”¨æ•°æ®åº“æ•°ï¼Œé»˜è®¤å€¼ä¸º16ï¼Œé»˜è®¤æ•°æ®åº“ä¸º0ï¼Œæ•°æ®åº“èŒƒå›´åœ¨0~15ä¹‹é—´åˆ‡æ¢ï¼Œå½¼æ­¤éš”ç¦»ã€‚
 
save
# ä¿å­˜æ•°æ®åˆ°ç£ç›˜ï¼Œæ ¼å¼ä¸ºsaveï¼ŒæŒ‡å‡ºåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶rdbã€‚ç›¸å½“äºæ¡ä»¶è§¦å‘æŠ“å–å¿«ç…§ï¼Œè¿™ä¸ªå¯ä»¥å¤šä¸ªæ¡ä»¶é…åˆã€‚
# save 9001å°±è¡¨ç¤º900ç§’å†…è‡³å°‘æœ‰1ä¸ªkeyè¢«æ”¹å˜å°±ä¿å­˜æ•°æ®åˆ°ç£ç›˜ã€‚
 
rdbcompression yes
# å­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶(æŒä¹…åŒ–åˆ°rdbæ–‡ä»¶)æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ä¸ºyesã€‚
 
dbfilename dump.rdb
# æœ¬åœ°æŒä¹…åŒ–æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºdump.rdbã€‚
 
dir ./
# å·¥ä½œç›®å½•ï¼Œæ•°æ®åº“é•œåƒå¤‡ä»½çš„æ–‡ä»¶æ”¾ç½®çš„è·¯å¾„ã€‚è¿™é‡Œçš„è·¯å¾„è·Ÿæ–‡ä»¶åè¦åˆ†å¼€é…ç½®æ˜¯å› ä¸ºredisåœ¨è¿›è¡Œå¤‡ä»½æ—¶ï¼Œå…ˆä¼šå°†å½“å‰æ•°æ®åº“çš„çŠ¶æ€å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œç­‰å¤‡ä»½å®Œæˆæ—¶ï¼Œå†æŠŠè¯¥ä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸ºä¸Šé¢æ‰€æŒ‡å®šçš„æ–‡ä»¶ã€‚ è€Œè¿™é‡Œçš„ä¸´æ—¶æ–‡ä»¶å’Œä¸Šé¢æ‰€é…ç½®çš„å¤‡ä»½æ–‡ä»¶éƒ½ä¼šæ”¾åœ¨è¿™ä¸ªæŒ‡å®šçš„è·¯å¾„å½“ä¸­ï¼ŒAOFæ–‡ä»¶ä¹Ÿä¼šå­˜æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹é¢ã€‚ æ³¨æ„è¿™é‡Œå¿…é¡»æŒ‡å®šä¸€ä¸ªç›®å½•è€Œä¸æ˜¯æ–‡ä»¶ã€‚
 
slaveof
# ä¸»ä»å¤åˆ¶ï¼Œè®¾ç½®è¯¥æ•°æ®åº“ä¸ºå…¶ä»–æ•°æ®åº“çš„ä»æ•°æ®åº“ã€‚è®¾ç½®å½“æœ¬æœºä¸ºslaveæœåŠ¡æ—¶ï¼Œè®¾ç½®masteræœåŠ¡çš„IPåœ°å€åŠç«¯å£ã€‚ åœ¨rediså¯åŠ¨æ—¶,å®ƒä¼šè‡ªåŠ¨ä»masterè¿›è¡Œæ•°æ®åŒæ­¥ã€‚
 
masterauth
# å½“masteræœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶(ç”¨requirepassåˆ¶å®šçš„å¯†ç )slaveæœåŠ¡è¿æ¥masterçš„å¯†ç ã€‚
 
slave-serve-stale-data yes
# å½“ä»åº“åŒä¸»æœºå¤±å»è¿æ¥æˆ–è€…å¤åˆ¶æ­£åœ¨è¿›è¡Œï¼Œä»æœºåº“æœ‰ä¸¤ç§è¿è¡Œæ–¹å¼ï¼š
# å¦‚æœslave-serve-stale-dataè®¾ç½®ä¸º yes(é»˜è®¤è®¾ç½®)ï¼Œä»åº“ä¼šç»§ç»­ç›¸åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚
# å¦‚æœslave-serve-stale-dataæ˜¯æŒ‡ä¸ºnoï¼Œé™¤å»INFOå’ŒSLAVOFå‘½ä»¤ä¹‹å¤–çš„ä»»ä½•è¯·æ±‚éƒ½ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯"SYNC with master in progress"ã€‚
 
repl-ping-slave-period 10
# ä»åº“ä¼šæŒ‰ç…§ä¸€ä¸ªæ—¶é—´é—´éš”å‘ä¸»åº“å‘é€PINGï¼Œå¯ä»¥é€šè¿‡repl-ping-slave-periodè®¾ç½®è¿™ä¸ªæ—¶é—´é—´éš”,é»˜è®¤æ˜¯10ç§’ã€‚
 
repl-timeout 60
# è®¾ç½®ä¸»åº“æ‰¹é‡æ•°æ®ä¼ è¾“æ—¶é—´æˆ–è€…pingå›å¤æ—¶é—´é—´éš”ï¼Œé»˜è®¤å€¼æ˜¯60ç§’ï¼Œä¸€å®šè¦ç¡®ä¿repl-timeoutå¤§äºrepl-ping-slave-periodã€‚
 
requirepass foobared
# è®¾ç½®å®¢æˆ·ç«¯è¿æ¥åè¿›è¡Œä»»ä½•å…¶ä»–æŒ‡å®šå‰éœ€è¦ä½¿ç”¨çš„å¯†ç ã€‚å› ä¸ºredisé€Ÿåº¦ç›¸å½“å¿«ï¼Œæ‰€ä»¥åœ¨ä¸€å°æ¯”è¾ƒå¥½çš„æœåŠ¡å™¨å¹³å°ä¸‹, ä¸€ä¸ªå¤–éƒ¨çš„ç”¨æˆ·å¯ä»¥åœ¨ä¸€ç§’é’Ÿè¿›è¡Œ150Kæ¬¡çš„å¯†ç å°è¯•ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦æŒ‡å®šéå¸¸å¼ºå¤§çš„å¯†ç æ¥é˜²æ­¢æš´åŠ›ç ´è§£ã€‚
 
rename command CONFIG â€œâ€
# å‘½ä»¤é‡å‘½åï¼Œåœ¨ä¸€ä¸ªå…±äº«ç¯å¢ƒä¸‹å¯ä»¥é‡å‘½åç›¸å¯¹å±é™©çš„å‘½ä»¤ï¼Œæ¯”å¦‚æŠŠCONFIGé‡åä¸ºä¸€ä¸ªä¸å®¹æ˜“çŒœæµ‹çš„å­—ç¬¦ï¼š
rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52
# å¦‚æœæƒ³åˆ é™¤ä¸€ä¸ªå‘½ä»¤ï¼Œç›´æ¥æŠŠå®ƒé‡å‘½åä¸ºä¸€ä¸ªç©ºå­—ç¬¦""å³å¯ï¼šrename-command CONFIG â€œâ€ã€‚
 
maxclients 128
# è®¾ç½®åŒä¸€æ—¶é—´æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ã€‚rediså¯ä»¥åŒæ—¶æ‰“å¼€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ä¸ºredisè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚
# å¦‚æœè®¾ç½® maxclients 0ï¼Œè¡¨ç¤ºä¸ä½œé™åˆ¶ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æ•°åˆ°è¾¾é™åˆ¶æ—¶ï¼Œredisä¼šå…³é—­æ–°çš„è¿æ¥å¹¶å‘å®¢æˆ·ç«¯è¿”å›max number of clients reachedé”™è¯¯ä¿¡æ¯ã€‚
 
maxmemory
# æŒ‡å®šredisæœ€å¤§å†…å­˜é™åˆ¶ã€‚redisåœ¨å¯åŠ¨æ—¶ä¼šæŠŠæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜åï¼Œredisä¼šå…ˆå°è¯•æ¸…é™¤å·²åˆ°æœŸæˆ–å³å°†åˆ°æœŸçš„keyï¼ŒredisåŒæ—¶ä¹Ÿä¼šç§»é™¤ç©ºçš„listå¯¹è±¡ã€‚å½“æ­¤æ–¹æ³•å¤„ç†å,ä»ç„¶åˆ°è¾¾æœ€å¤§å†…å­˜è®¾ç½®ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä½†ä»ç„¶å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚
# æ³¨æ„ï¼šredisæ–°çš„vmæœºåˆ¶ï¼Œä¼šæŠŠkeyå­˜æ”¾å†…å­˜ï¼Œvalueä¼šå­˜æ”¾åœ¨swapåŒºã€‚
 
maxmemory-policy volatile-lru
# å½“å†…å­˜è¾¾åˆ°æœ€å¤§å€¼çš„æ—¶å€™redisä¼šé€‰æ‹©åˆ é™¤å“ªäº›æ•°æ®å‘¢ï¼Ÿæœ‰äº”ç§æ–¹å¼å¯ä¾›é€‰æ‹©ï¼š
# 1ï¼volatile-lruä»£è¡¨åˆ©ç”¨LRUç®—æ³•ç§»é™¤è®¾ç½®è¿‡æœŸæ—¶é—´çš„key(LRUï¼šæœ€è¿‘ä½¿ç”¨LeastRecentlyUsed)
# 2ï¼allkeys-lruä»£è¡¨åˆ©ç”¨LRUç®—æ³•ç§»é™¤ä»»ä½•key
# 3ï¼volatile-randomä»£è¡¨ç§»é™¤è®¾ç½®è¿‡è¿‡æœŸæ—¶é—´çš„éšæœºkey
# 4ï¼allkeys_randomä»£è¡¨ç§»é™¤ä¸€ä¸ªéšæœºçš„key
# 5ï¼ volatile-ttlä»£è¡¨ç§»é™¤å³å°†è¿‡æœŸçš„key(minor TTL)
# 6ï¼ noevictionä»£è¡¨ä¸ç§»é™¤ä»»ä½•keyï¼Œåªæ˜¯è¿”å›ä¸€ä¸ªå†™é”™è¯¯
# æ³¨æ„ï¼šå¯¹äºä¸Šé¢çš„ç­–ç•¥ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„keyå¯ä»¥ç§»é™¤ï¼Œå†™çš„æ—¶å€™redisä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚
 
appendonly no
# é»˜è®¤æƒ…å†µä¸‹ï¼Œredisä¼šåœ¨åå°å¼‚æ­¥çš„æŠŠæ•°æ®åº“é•œåƒå¤‡ä»½åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¯¥å¤‡ä»½æ˜¯éå¸¸è€—æ—¶çš„ï¼Œè€Œä¸”å¤‡ä»½ä¹Ÿä¸èƒ½å¾ˆé¢‘ç¹ã€‚ å¦‚æœå‘ç”Ÿè¯¸å¦‚æ‹‰é—¸é™ç”µã€æ‹”æ’å¤´ç­‰çŠ¶å†µï¼Œé‚£ä¹ˆå°†é€ æˆæ¯”è¾ƒå¤§èŒƒå›´çš„æ•°æ®ä¸¢å¤±ï¼Œæ‰€ä»¥redisæä¾›äº†å¦å¤–ä¸€ç§æ›´åŠ é«˜æ•ˆçš„æ•°æ®åº“å¤‡ä»½åŠç¾éš¾æ¢å¤æ–¹å¼ã€‚
# å¼€å¯append onlyæ¨¡å¼ä¹‹åï¼Œredisä¼šæŠŠæ‰€æ¥æ”¶åˆ°çš„æ¯ä¸€æ¬¡å†™æ“ä½œè¯·æ±‚éƒ½è¿½åŠ åˆ°appendonly. aofæ–‡ä»¶ä¸­ã€‚å½“redisé‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šä»è¯¥æ–‡ä»¶æ¢å¤å‡ºä¹‹å‰çš„çŠ¶æ€ï¼Œä½†æ˜¯è¿™æ ·ä¼šé€ æˆappendonly. aofæ–‡ä»¶è¿‡å¤§ï¼Œæ‰€ä»¥redisè¿˜æ”¯æŒBGREWRITEAOFæŒ‡ä»¤å¯¹appendonly.aofã€‚
 
appendfilename appendonly.aof
# AOFæ–‡ä»¶åç§°ï¼Œé»˜è®¤ä¸º"appendonly.aof"ã€‚
 
appendfsync everysec
# redisæ”¯æŒä¸‰ç§åŒæ­¥AOFæ–‡ä»¶çš„ç­–ç•¥ï¼š
# 1ï¼noä»£è¡¨ä¸è¿›è¡ŒåŒæ­¥,ç³»ç»Ÿå»æ“ä½œ
# 2ï¼alwaysä»£è¡¨æ¯æ¬¡æœ‰å†™æ“ä½œéƒ½è¿›è¡ŒåŒæ­¥
# 3ï¼everysecä»£è¡¨å¯¹å†™æ“ä½œè¿›è¡Œç´¯ç§¯ï¼Œæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œé»˜è®¤æ˜¯"everysec"ï¼ŒæŒ‰ç…§é€Ÿåº¦å’Œå®‰å…¨æŠ˜ä¸­è¿™æ˜¯æœ€å¥½çš„
 
slowlog-log-slower-than 10000
# è®°å½•è¶…è¿‡ç‰¹å®šæ‰§è¡Œæ—¶é—´çš„å‘½ä»¤ã€‚æ‰§è¡Œæ—¶é—´ä¸åŒ…æ‹¬I/Oè®¡ç®—ï¼Œæ¯”å¦‚è¿æ¥å®¢æˆ·ç«¯ï¼Œè¿”å›ç»“æœç­‰ã€‚åªæ˜¯å‘½ä»¤æ‰§è¡Œæ—¶é—´ï¼Œå¯ä»¥é€šè¿‡ä¸¤ä¸ªå‚æ•°è®¾ç½®slow logï¼šä¸€ä¸ªæ˜¯å‘Šè¯‰Redisæ‰§è¡Œè¶…è¿‡å¤šå°‘æ—¶é—´è¢«è®°å½•çš„å‚æ•°slowlog-log-slower-than(å¾®å¦™)ï¼Œå¦ä¸€ä¸ªæ˜¯slow log çš„é•¿åº¦ã€‚
# å½“ä¸€ä¸ªæ–°å‘½ä»¤è¢«è®°å½•çš„æ—¶å€™æœ€æ—©çš„å‘½ä»¤å°†è¢«ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œä¸‹é¢çš„æ—¶é—´ä»¥å¾®å¦™å¾®å•ä½ï¼Œå› æ­¤1000000ä»£è¡¨ä¸€åˆ†é’Ÿã€‚æ³¨æ„åˆ¶å®šä¸€ä¸ªè´Ÿæ•°å°†å…³é—­æ…¢æ—¥å¿—ï¼Œè€Œè®¾ç½®ä¸º0å°†å¼ºåˆ¶æ¯ä¸ªå‘½ä»¤éƒ½ä¼šè®°å½•ã€‚
 
hash-max-zipmap-entries 512 && hash-maxz-ipmap-value 64
# å½“hashä¸­åŒ…å«è¶…è¿‡æŒ‡å®šå…ƒç´ ä¸ªæ•°å¹¶ä¸”æœ€å¤§çš„å…ƒç´ æ²¡æœ‰è¶…è¿‡ä¸´ç•Œæ—¶ï¼Œhashå°†ä»¥ä¸€ç§ç‰¹æ®Šçš„ç¼–ç æ–¹å¼(å¤§å¤§å‡å°‘å†…å­˜ä½¿ç”¨)æ¥å­˜å‚¨ï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®è¿™ä¸¤ä¸ªä¸´ç•Œå€¼ã€‚Redis Hashå¯¹åº”Valueå†…éƒ¨å®é™…å°±æ˜¯ä¸€ä¸ªHashMapï¼Œå®é™…è¿™é‡Œä¼šæœ‰2ç§ä¸åŒå®ç°ã€‚è¿™ä¸ªHashçš„æˆå‘˜æ¯”è¾ƒå°‘æ—¶redisä¸ºäº†èŠ‚çœå†…å­˜ä¼šé‡‡ç”¨ç±»ä¼¼ä¸€ç»´æ•°ç»„çš„æ–¹å¼æ¥ç´§å‡‘å­˜å‚¨ï¼Œè€Œä¸ä¼šé‡‡ç”¨çœŸæ­£çš„HashMapç»“æ„ï¼Œå¯¹åº”çš„value redisObjectçš„encodingä¸ºzipmapã€‚å½“æˆå‘˜æ•°é‡å¢å¤§æ—¶ä¼šè‡ªåŠ¨è½¬æˆçœŸæ­£çš„HashMapï¼Œæ­¤æ—¶encodingä¸ºhtã€‚
 
hash-max-zipmap-entries 512 512
# listæ•°æ®ç±»å‹å¤šå°‘èŠ‚ç‚¹ä»¥ä¸‹ä¼šé‡‡ç”¨å»æŒ‡é’ˆçš„ç´§å‡‘å­˜å‚¨æ ¼å¼ã€‚
 
list-max-ziplist-value 64
# æ•°æ®ç±»å‹èŠ‚ç‚¹å€¼å¤§å°å°äºå¤šå°‘å­—èŠ‚ä¼šé‡‡ç”¨ç´§å‡‘å­˜å‚¨æ ¼å¼ã€‚
 
setmaxintsetentries 512
# setæ•°æ®ç±»å‹å†…éƒ¨æ•°æ®å¦‚æœå…¨éƒ¨æ˜¯æ•°å€¼å‹,ä¸”åŒ…å«å¤šå°‘èŠ‚ç‚¹ä»¥ä¸‹ä¼šé‡‡ç”¨ç´§å‡‘æ ¼å¼å­˜å‚¨ã€‚
 
zsetmaxziplistentries 128
# zsortæ•°æ®ç±»å‹å¤šå°‘èŠ‚ç‚¹ä»¥ä¸‹ä¼šé‡‡ç”¨å»æŒ‡é’ˆçš„ç´§å‡‘å­˜å‚¨æ ¼å¼ã€‚
 
zsetmaxziplistvalue 64
# zsortæ•°æ®ç±»å‹èŠ‚ç‚¹å€¼å¤§å°å°äºå¤šå°‘å­—èŠ‚ä¼šé‡‡ç”¨ç´§å‡‘å­˜å‚¨æ ¼å¼ã€‚
 
activerehashing yes
# rediså°†åœ¨æ¯100æ¯«ç§’æ—¶ä½¿ç”¨1æ¯«ç§’çš„CPUæ—¶é—´æ¥å¯¹redisçš„hashè¡¨è¿›è¡Œé‡æ–°hashï¼Œå¯ä»¥é™ä½å†…å­˜çš„ä½¿ç”¨ã€‚
# å½“ä½ çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œæœ‰éå¸¸ä¸¥æ ¼çš„å®æ—¶æ€§éœ€è¦ï¼Œä¸èƒ½å¤Ÿæ¥å—redisæ—¶ä¸æ—¶çš„å¯¹è¯·æ±‚æœ‰2æ¯«ç§’çš„å»¶è¿Ÿçš„è¯ï¼ŒæŠŠè¿™é¡¹é…ç½®ä¸ºnoã€‚å¦‚æœæ²¡æœ‰è¿™ä¹ˆä¸¥æ ¼çš„å®æ—¶æ€§è¦æ±‚ï¼Œå¯ä»¥è®¾ç½®ä¸ºyesï¼Œä»¥ä¾¿èƒ½å¤Ÿå°½å¯èƒ½å¿«çš„é‡Šæ”¾å†…å­˜ã€‚
~~~

##### 1.2 å®¿ä¸»æœºä¸­åˆ›å»ºredisç›®å½•ç”¨äºæŒ‚è½½

~~~shell
mkdir /mydata/redis

# ç”¨äºå­˜æ”¾é…ç½®æ–‡ä»¶
touch /mydata/redis/redis.conf

# ç”¨äºå­˜æ”¾æ•°æ®
touch /mydata/redis/data

# ç”¨äºå­˜æ”¾æ—¥å¿—
touch /mydata/redis/logs
~~~

##### 1.3 æ‹‰å–Redisé•œåƒ

```shell
docker pull redis
```

##### 1.4 æ„å»ºå®¹å™¨

```æ„å»ºå®¹å™¨
docker run \
-p 6379:6379 \
--name redis \
-v /mydata/redis/redis.conf:/etc/redis/redis.config \
-v /mydata/redis/data:/var/lib/redis \
-v /mydata/redis/logs:/logs \
-d \
--privileged=true \
--restart=always \
redis:latest \
redis-server /etc/redis/redis.config
```

-dä»£è¡¨åå°è¿è¡Œå®¹å™¨

#### 2.linuxç”¨å®šæ—¶è°ƒç”¨luaè„šæœ¬æ¥æ¸…é™¤redisä¸­å­˜å‚¨çš„é€€é€‰æ•°æ®

##### 2.1 Luaè„šæœ¬å­˜æ”¾åœ¨/mydata/luaä¸‹åä¸ºdel_keys.luaçš„æ–‡ä»¶ä¸­

~~~lua
local keys = redis.call('KEYS', 'cancelSchedule*')  
for i,key in ipairs(keys) do  
    redis.call('DEL', key)  
end  
return 'Keys deleted'
~~~

##### 2.2 æ‹·è´è¿›å…¥rediså®¹å™¨ä¸­

~~~shell
docker cp /mydata/lua/del_keys.lua redis:/opt
~~~

##### 2.3 delete_redis_keys.sh  

~~~shell
#!/bin/bash  
# delete_redis_keys.sh  
  
# æ›¿æ¢ä»¥ä¸‹å˜é‡ä¸ºä½ çš„å®¹å™¨åç§°æˆ–IDä»¥åŠå¯†ç   
CONTAINER_NAME_OR_ID="redis"  
REDIS_PASSWORD="123456"  
  
# æ‰§è¡Œdocker execå‘½ä»¤  
docker exec -i $CONTAINER_NAME_OR_ID redis-cli -a $REDIS_PASSWORD --eval /opt/del_keys.lua ,0
~~~

##### 2.4 æ·»åŠ æ‰§è¡Œæƒé™

~~~shell
chmod +x delete_redis_keys.sh
~~~

##### 2.5 è®¾ç½®å®šæ—¶ä»»åŠ¡

~~~shell
crontab -e 
0 0 1 * * /mydata/shell/delete_redis_keys.sh
~~~

### äº”ã€åç«¯

#### 1.Dockerfileç¼–å†™

##### admin

```dockerfile
FROM openjdk:8
VOLUME /tmp
ADD admin-1.0-SNAPSHOT.jar admin.jar
EXPOSE 7070
ENTRYPOINT ["java","-jar","/admin.jar"]
```

##### weixin

```dockerfile
FROM openjdk:8
VOLUME /tmp
ADD weixin-1.0-SNAPSHOT.jar weixin.jar
EXPOSE 7777
ENTRYPOINT ["java","-jar","/weixin.jar"]
```

#### 2. é€šè¿‡Dockerfileåˆ›å»ºé•œåƒ

    docker build -t weixin .
    docker build -t admin .

#### 3. åˆ›å»ºå®¹å™¨ï¼ˆå°ç¨‹åºæ”¾è¡Œç«¯å£7777ï¼Œåå°æ”¾è¡Œç«¯å£7070ï¼‰

    docker run -d -p 7070:7070 --restart=always -e TZ="Asia/Shanghai"  --name admin admin
    docker run -d -p 7777:7777 --restart=always -e TZ="Asia/Shanghai" --name weixin weixin

### å…­ã€nginxé…ç½®

#### 1. åˆ›å»ºå·¥å…·å®¹å™¨

    docker run -d --name nginx01 -p 80:80  nginx:latest

#### 2. å¯¼å‡ºé»˜è®¤é…ç½®æ–‡ä»¶

##### 2.1 æ–°å»ºæœ¬åœ°nginxé…ç½®æ–‡ä»¶

    mkdir /mydata/nginx

##### 2.2 æ˜ å°„å·¥å…·å®¹å™¨å†…æ–‡ä»¶åˆ°æœ¬åœ°

    docker cp nginx01:/etc/nginx/nginx.conf /mydata/nginx/
    docker cp nginx01:/etc/nginx/conf.d /mydata/nginx/conf/
    docker cp nginx01:/usr/share/nginx/html /mydata/nginx/html
    docker cp nginx01:/var/log/nginx/ /mydata/nginx/logs/

##### 2.3 åˆ é™¤å·¥å…·å®¹å™¨

    docker kill nginx01
    docker rm nginx01

#### 3.åˆ›å»ºç”¨äºéƒ¨ç½²å‰ç«¯çš„nginxå®¹å™¨ 

##### 3.1 å‰å°ç”¨80ç«¯å£,åå°ç”¨8080ç«¯å£,è¿™é‡Œå®¹å™¨ä½¿ç”¨ç«¯å£80å’Œ8080,äº‘æœåŠ¡å™¨ä¹Ÿè¦æ”¾è¡Œå¯¹åº”ç«¯å£

    docker run -d  --name nginx -p 80:80 -p 8080:8080 --restart=always -v /mydata/nginx/nginx.conf:/etc/nginx/nginx.conf -v /mydata/nginx/logs:/var/log/nginx -v /mydata/nginx/html:/usr/share/nginx/html -v /mydata/nginx/conf:/etc/nginx/conf.d --privileged=true     -e TZ=Asia/Shanghai nginx:latest

#### 4. åœ¨nginxä¸‹çš„htmlåˆ›å»ºç”¨äºå­˜æ”¾å‰ç«¯æ‰“åŒ…å¥½çš„ä»£ç çš„æ–‡ä»¶å¤¹

#### 5. ä¿®æ”¹/nginx/confä¸‹çš„é…ç½®æ–‡ä»¶ï¼ˆä¸¤ä¸ªconfï¼‰

##### 5.1 admin.conf 

```xml
server {
    listen       8080;
    listen  [::]:8080;
    server_name  admin;

    location  /{
        root   /usr/share/nginx/html/admin;
        try_files $uri $uri/ @router;
        index  index.html index.htm;
    }
    location @router {
    rewrite ^.*$ /index.html last;
    }
    
    location  /dev-api/{
        proxy_pass   http://124.70.136.242:7070/;
    }
    location  /prod-api/{
        proxy_pass   http://124.70.136.242:7070/;
    }
    location  /stage-api/{
        proxy_pass   http://124.70.136.242:7070/;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
    
}
```

åˆ°è¿™é‡Œå°±éƒ¨ç½²å®Œæˆäº†å¯ä»¥è®¿é—®æµè§ˆå™¨ip:8080ç«¯å£æŸ¥çœ‹

### ä¸ƒã€Docker Compose</span>

#### 1.å®‰è£…

```shell
# ä¸‹è½½æŸç‰ˆæœ¬docker-composeæ–‡ä»¶å¹¶æ”¹ådocker-composeç§»åŠ¨è‡³/usr/local/bin
curl -L "https://github.com/docker/compose/releases/download/1.28.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
# æˆæƒdocker-composeå¯æ‰§è¡Œ
chmod +x /usr/local/bin/docker-compose
# æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ
docker-compose -v
```

#### 2.ç›®å½•å±‚çº§ï¼ˆå°†æ‰“åŒ…å¥½çš„åç«¯jarä¸å‰ç«¯å­˜æ”¾åœ¨æŒ‡å®šç›®å½•ä»¥åŠæ•°æ®åº“sqlæ–‡ä»¶ï¼‰

```shell
.
â”œâ”€â”€ backend
â”‚Â Â  â”œâ”€â”€ admin
â”‚Â Â  â”‚Â Â  â””â”€â”€ admin-1.0-SNAPSHOT.jar
â”‚Â Â  â””â”€â”€ weixin
â”‚Â Â      â””â”€â”€ weixin-1.0-SNAPSHOT.jar
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ frontend
â”‚Â Â  â””â”€â”€ dist
â”‚Â Â      â”œâ”€â”€ favicon.ico
â”‚Â Â      â”œâ”€â”€ index.html
â”‚Â Â      â””â”€â”€ static
â”œâ”€â”€ mysql
â”‚Â Â  â””â”€â”€ init
â”‚Â Â      â””â”€â”€ redcross.sql
â”œâ”€â”€ nginx
â”‚Â Â  â”œâ”€â”€ conf.d
â”‚Â Â  â”‚Â Â  â””â”€â”€ default.conf
â”‚Â Â  â””â”€â”€ nginx.conf
â””â”€â”€ redis
    â””â”€â”€ redis.conf
```

#### 3.docker-compose.ymlç¼–å†™

```shell
version: '3'

services:
  admin:
    build:
      context: .
      dockerfile: Dockerfile
      target: admin
    container_name: admin
    restart: always
    command: ["java", "-jar", "/admin.jar"]
    ports:
      - "7070:7070"
    depends_on:
      - redis
      - rabbitmq
      - mysql
    networks:
      - app-network

  weixin:
    build:
      context: .
      dockerfile: Dockerfile
      target: weixin
    container_name: weixin
    restart: always
    command: ["java", "-jar", "/weixin.jar"]
    ports:
      - "7777:7777"
    depends_on:
      - redis
      - rabbitmq
      - mysql
    networks:
      - app-network

  frontend:
    image: nginx:alpine
    container_name: nginx
    restart: always
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    ports:
      - "80:80"
      - "8080:8080"
    networks:
      - app-network
      
  redis:
    image: redis:latest
    restart: always
    container_name: redis
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: ["redis-server",  "/usr/local/etc/redis/redis.conf"]
    ports:
      - "6379:6379" 
    networks:
      - app-network

  rabbitmq:
    image: rabbitmq:management
    container_name: mq
    restart: always
    ports:
      - "15672:15672"  # RabbitMQ ç®¡ç†ç•Œé¢
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_USER: theRedCross
      RABBITMQ_DEFAULT_PASS: theRedCross1993
    networks:
      - app-network

  mysql:
    image: mysql:8.0
    container_name: mysql8
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: theRedCross1993
    volumes:
      - ./mysql/init:/docker-entrypoint-initdb.d/
    ports:
      - "3306:3306"  # RabbitMQ ç®¡ç†ç•Œé¢
    networks:
      - app-network
  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M
    ports:
      - "9999:9000"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock #æ•°æ®æ–‡ä»¶æŒ‚è½½
      - portainer_data:/data portainer/portainer-ce #é…ç½®æ–‡ä»¶æŒ‚è½½
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone/timezone:/etc/timezone:ro
 
# å­˜å‚¨å·
volumes:
  portainer_data:
networks:
  app-network:
```

#### 4.Dockerfileç¼–å†™

```shell
# Dockerfile
FROM openjdk:8 as base
WORKDIR /app

# å®šä¹‰ç¬¬ä¸€ä¸ªæ„å»ºé˜¶æ®µ weixin
FROM base as weixin
COPY backend/weixin/weixin-1.0-SNAPSHOT.jar weixin.jar
EXPOSE 7777
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone
ENTRYPOINT ["java", "-jar", "weixin.jar"]

# å®šä¹‰ç¬¬äºŒä¸ªæ„å»ºé˜¶æ®µ admin
FROM base as admin
COPY backend/admin/admin-1.0-SNAPSHOT.jar admin.jar
EXPOSE 7070
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone
ENTRYPOINT ["java", "-jar", "admin.jar"]
```

#### 5.ä¸€é”®éƒ¨ç½²

åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œ

```shell
docker-compose up -d
```

### é—®é¢˜

#### å¿—æ„¿æ´»åŠ¨æ²¡æœ‰æ˜¾ç¤ºæ’ç­

åç«¯å®¹å™¨æ—¶é—´é—®é¢˜ -e TZ="Asia/Shanghai"
